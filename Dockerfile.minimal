# æœ€ç®€ç‰ˆDockerfile - ä»…ä½¿ç”¨æ ‡å‡†åº“æ„å»º

FROM golang:1.21-alpine AS builder

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apk add --no-cache git ca-certificates tzdata

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºæœ€ç®€åŒ–çš„main.go
RUN cat > main.go << 'EOF'
package main

import (
	"encoding/json"
	"fmt"
	"log"
	"net/http"
	"time"
)

type SystemInfo struct {
	Name        string    `json:"name"`
	Version     string    `json:"version"`
	Status      string    `json:"status"`
	Timestamp   time.Time `json:"timestamp"`
	Description string    `json:"description"`
}

type HealthCheck struct {
	Status    string    `json:"status"`
	Timestamp time.Time `json:"timestamp"`
	Services  map[string]string `json:"services"`
}

func main() {
	// ç³»ç»Ÿä¿¡æ¯æ¥å£
	http.HandleFunc("/api/v1/system/info", func(w http.ResponseWriter, r *http.Request) {
		info := SystemInfo{
			Name:        "SecureFingerprint",
			Version:     "v1.0.0",
			Status:      "running",
			Timestamp:   time.Now(),
			Description: "æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ - åŸºäºç”¨æˆ·æŒ‡çº¹çš„è¡Œä¸ºåˆ†æå’Œé£é™©æ§åˆ¶",
		}
		
		w.Header().Set("Content-Type", "application/json")
		w.Header().Set("Access-Control-Allow-Origin", "*")
		json.NewEncoder(w).Encode(map[string]interface{}{
			"success": true,
			"data":    info,
		})
	})

	// å¥åº·æ£€æŸ¥æ¥å£
	http.HandleFunc("/api/v1/system/health", func(w http.ResponseWriter, r *http.Request) {
		health := HealthCheck{
			Status:    "healthy",
			Timestamp: time.Now(),
			Services: map[string]string{
				"api": "running",
				"web": "running",
			},
		}
		
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(map[string]interface{}{
			"success": true,
			"data":    health,
		})
	})

	// æ ¹è·¯å¾„
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		if r.URL.Path != "/" {
			http.NotFound(w, r)
			return
		}
		
		html := `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureFingerprint - æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 40px; background: #f5f7fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 48px; margin-bottom: 10px; }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .feature { padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #409eff; }
        .api-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .endpoint { background: white; padding: 10px; margin: 8px 0; border-radius: 4px; font-family: monospace; }
        .status { display: inline-block; padding: 8px 16px; background: #67c23a; color: white; border-radius: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ›¡ï¸</div>
            <h1>SecureFingerprint</h1>
            <p class="subtitle">æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ</p>
            <div class="status">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
        </div>
        
        <div class="features">
            <div class="feature">
                <h3>ğŸ” ç”¨æˆ·æŒ‡çº¹è¯†åˆ«</h3>
                <p>åŸºäºå¤šç»´åº¦ä¿¡æ¯ç”Ÿæˆç¨³å®šçš„ç”¨æˆ·æ ‡è¯†</p>
            </div>
            <div class="feature">
                <h3>ğŸ“Š è¡Œä¸ºåˆ†æ</h3>
                <p>å®æ—¶åˆ†æç”¨æˆ·è®¿é—®æ¨¡å¼å’Œé£é™©ç­‰çº§</p>
            </div>
            <div class="feature">
                <h3>ğŸ”’ è®¿é—®æ§åˆ¶</h3>
                <p>å¤šå±‚é˜²æŠ¤æœºåˆ¶ï¼Œæ™ºèƒ½æ‹¦æˆªæ¶æ„è®¿é—®</p>
            </div>
            <div class="feature">
                <h3>ğŸ“ˆ å®æ—¶ç›‘æ§</h3>
                <p>å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼Œå…¨é¢æŒæ§ç³»ç»ŸçŠ¶æ€</p>
            </div>
        </div>
        
        <div class="api-section">
            <h3>ğŸ”Œ API æ¥å£</h3>
            <div class="endpoint">GET /api/v1/system/info - ç³»ç»Ÿä¿¡æ¯</div>
            <div class="endpoint">GET /api/v1/system/health - å¥åº·æ£€æŸ¥</div>
        </div>
        
        <script>
            fetch('/api/v1/system/health')
                .then(r => r.json())
                .then(data => console.log('ç³»ç»ŸçŠ¶æ€:', data))
                .catch(e => console.error('APIé”™è¯¯:', e));
        </script>
    </div>
</body>
</html>`
		
		w.Header().Set("Content-Type", "text/html; charset=utf-8")
		fmt.Fprint(w, html)
	})

	log.Println("ğŸ›¡ï¸ SecureFingerprint å¯åŠ¨å®Œæˆ")
	log.Println("ğŸŒ è®¿é—®åœ°å€: http://localhost:8080")
	log.Println("ğŸ“Š ç³»ç»Ÿä¿¡æ¯: http://localhost:8080/api/v1/system/info")
	log.Println("ğŸ’š å¥åº·æ£€æŸ¥: http://localhost:8080/api/v1/system/health")
	
	if err := http.ListenAndServe(":8080", nil); err != nil {
		log.Fatal("æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:", err)
	}
}
EOF

# åˆå§‹åŒ–Goæ¨¡å—
RUN go mod init securefingerprint

# æ„å»ºåº”ç”¨
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags '-s -w' -o securefingerprint main.go

# æœ€ç»ˆè¿è¡Œé˜¶æ®µ
FROM alpine:latest

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk --no-cache add ca-certificates tzdata

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/securefingerprint .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs data && \
    chown -R appuser:appgroup /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/system/health || exit 1

# è®¾ç½®æ ‡ç­¾
LABEL maintainer="ZBaimo" \
      version="1.0.0" \
      description="SecureFingerprint - æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ" \
      org.opencontainers.image.title="SecureFingerprint" \
      org.opencontainers.image.description="åŸºäºç”¨æˆ·æŒ‡çº¹çš„æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ" \
      org.opencontainers.image.version="1.0.0" \
      org.opencontainers.image.vendor="ZBaimo" \
      org.opencontainers.image.licenses="MIT"

# å¯åŠ¨åº”ç”¨
CMD ["./securefingerprint"]
