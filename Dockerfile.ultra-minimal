# è¶…ç®€ç‰ˆDockerfile - å®Œå…¨æ— ä¾èµ–æ„å»º

FROM golang:1.21-alpine AS builder

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apk add --no-cache ca-certificates tzdata

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºæœ€ç®€åŒ–çš„main.goï¼ˆå†…åµŒæ‰€æœ‰ä»£ç ï¼‰
RUN cat > main.go << 'EOF'
package main

import (
	"encoding/json"
	"fmt"
	"log"
	"net/http"
	"time"
)

func main() {
	// ç³»ç»Ÿä¿¡æ¯æ¥å£
	http.HandleFunc("/api/v1/system/info", func(w http.ResponseWriter, r *http.Request) {
		info := map[string]interface{}{
			"name":        "SecureFingerprint",
			"version":     "v1.0.0",
			"status":      "running",
			"timestamp":   time.Now(),
			"description": "æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ",
		}
		
		w.Header().Set("Content-Type", "application/json")
		w.Header().Set("Access-Control-Allow-Origin", "*")
		json.NewEncoder(w).Encode(map[string]interface{}{
			"success": true,
			"data":    info,
		})
	})

	// å¥åº·æ£€æŸ¥æ¥å£
	http.HandleFunc("/api/v1/system/health", func(w http.ResponseWriter, r *http.Request) {
		health := map[string]interface{}{
			"status":    "healthy",
			"timestamp": time.Now(),
			"services": map[string]string{
				"api": "running",
				"web": "running",
			},
		}
		
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(map[string]interface{}{
			"success": true,
			"data":    health,
		})
	})

	// æ ¹è·¯å¾„ - æä¾›ç®€æ´çš„Webç•Œé¢
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		html := `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>SecureFingerprint</title>
<style>body{font-family:Arial,sans-serif;margin:0;padding:40px;background:#f5f7fa}
.container{max-width:800px;margin:0 auto;background:white;padding:40px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.header{text-align:center;margin-bottom:30px}.logo{font-size:48px;margin-bottom:10px}
h1{color:#333;margin-bottom:10px}.subtitle{color:#666;margin-bottom:30px}
.status{display:inline-block;padding:8px 16px;background:#67c23a;color:white;border-radius:20px;margin:20px 0}
.api{background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0}
.endpoint{background:white;padding:10px;margin:8px 0;border-radius:4px;font-family:monospace}
</style></head><body>
<div class="container">
<div class="header">
<div class="logo">ğŸ›¡ï¸</div>
<h1>SecureFingerprint</h1>
<p class="subtitle">æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ</p>
<div class="status">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
</div>
<div class="api">
<h3>ğŸ”Œ API æ¥å£</h3>
<div class="endpoint">GET /api/v1/system/info - ç³»ç»Ÿä¿¡æ¯</div>
<div class="endpoint">GET /api/v1/system/health - å¥åº·æ£€æŸ¥</div>
</div>
</div>
<script>fetch('/api/v1/system/health').then(r=>r.json()).then(d=>console.log('ç³»ç»ŸçŠ¶æ€:',d))</script>
</body></html>`
		
		w.Header().Set("Content-Type", "text/html; charset=utf-8")
		fmt.Fprint(w, html)
	})

	log.Println("ğŸ›¡ï¸ SecureFingerprint v1.0.0 å¯åŠ¨å®Œæˆ")
	log.Println("ğŸŒ è®¿é—®åœ°å€: http://localhost:8080")
	log.Println("ğŸ“Š APIæ¥å£: http://localhost:8080/api/v1/system/info")
	
	if err := http.ListenAndServe(":8080", nil); err != nil {
		log.Fatal("å¯åŠ¨å¤±è´¥:", err)
	}
}
EOF

# ç›´æ¥æ„å»ºï¼Œæ— éœ€go.mod
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags '-s -w' -o securefingerprint main.go

# æœ€ç»ˆè¿è¡Œé˜¶æ®µ
FROM scratch

# å¤åˆ¶CAè¯ä¹¦
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# å¤åˆ¶æ—¶åŒºæ•°æ®
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/securefingerprint /securefingerprint

# æš´éœ²ç«¯å£
EXPOSE 8080

# è®¾ç½®æ ‡ç­¾
LABEL maintainer="ZBaimo" \
      version="1.0.0" \
      description="SecureFingerprint - æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ" \
      org.opencontainers.image.title="SecureFingerprint" \
      org.opencontainers.image.description="åŸºäºç”¨æˆ·æŒ‡çº¹çš„æ™ºèƒ½è®¿é—®æ§åˆ¶ç³»ç»Ÿ" \
      org.opencontainers.image.version="1.0.0" \
      org.opencontainers.image.vendor="ZBaimo" \
      org.opencontainers.image.licenses="MIT"

# å¯åŠ¨åº”ç”¨
CMD ["/securefingerprint"]
